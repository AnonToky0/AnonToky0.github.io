---
title: "计算机网络"
date: 2025-08-23 22:00:00 +0800
categories: [计算机网络]
tags: [标签1, 标签2]
---

## 1. DNS

***

域名系统(Domain Name System)是一种分布式数据库系统，用于将域名转换为IP地址。  
DNS通过一系列的查询，将域名转为IP地址。

### 基本流程
1. 用户输入域名，如www.example.com
2. 浏览器检查本地DNS缓存是否有对应的IP地址。如果没有，查询请求发送给本地操作系统的DNS解析器
3. 本地计算器的DNS解析器将查询请求发送到配置的递归DNS服务器
4. 递归查询过程：
- 根域名服务器：递归解析器首先向根域名服务器查询，获取负责顶级域(如.com)的服务器信息
- TLD服务器(顶级域名服务器)：递归解析器随后向TLD服务器查询，获取负责该具体域名(example.com)的权威DNS服务器信息
- 权威DNS服务器：递归解析器最终向权威DNS服务器查询，获取域名对应的IP地址
5. 返回结果：递归解析器将IP地址返回给用户的计算机，浏览器使用该IP与目标服务器建立连接。
		
### DNS 结构
DNS采用树状层次结构，分为多个层级。
- 根域名服务器  
	位于DNS层次结构的最顶端，管理所有顶级域(TLD)的信息。全球有13组根服务器
- 顶级域名服务器(Top-Level Domain, TLD)  
TLD服务器管理特定类别的顶级域，如通用顶级域(gTLD), 国家顶级域(ccTLD)  
TLD服务器负责将查询请求指向负责具体域名的权威DNS服务器
- 权威域名服务器
权威域名服务器存储具体域名的DNS记录，直接回答关于该域名的解析请求
		
### DNS记录类型
DNS记录是域名与信息之间的映射关系，常见的DNS记录类型包括
- A记录:		将域名映射到一个IPv4地址，如 www.example.com. IN A 93.184.216.34
- AAAA记录：	将域名映射到一个IPv6地址，如 www.example.com. IN AAAA 2606:2800:220:1:248:1893:25c8:1946
- CNAME记录:	为一个域名设置别名，指向另一个规范域名
			
### DNS缓存
DNS缓存机制通过在不同层级存储解析结果，减少查询延迟，提高效率

#### 本地缓存
- 操作系统缓存：操作系统会缓存最近的DNS查询结果
- 应用程序缓存：如浏览器有自己的DNS缓存机制
#### 递归解析器缓存
ISP的递归服务器：互联网服务提供商(ISP)通常运行递归解析器，缓存频繁查询的结果，减少对根和TLD的请求
#### 缓存策略
- TTL(Time to Live): 每条DNS记录都有一个TTL值，指示该记录的缓存有效时间。TTL到期后，缓存需要刷新获取最新数据。
- 负面缓存：当DNS查询失败，解析器也会缓存该失败结果一段时间，防止重复无效查询。
		
### DNS传输
DNS作为应用层协议，主要使用传输层协议(UDP和TCP)进行数据传输  
DNS服务监听的默认端口号为 **53**，无论UDP、TCP都是
		
UDP(用户数据报协议)通常用于标准查询和响应：因为UDP低延迟低开销，适合小规模数据传输(默认最大DNS UDP包为512字节)  
当DNS响应超过UDP限制时，解析器会切换到TCP(传输控制协议)重新请求  
主DNS服务器和从服务器之间同步DNS记录时，也会使用TCP保证数据完整传输
	
### DNS安全
- DNS over HTTPS(DoH)
DoH是指HTTPS协议查询DNS查询和响应。将DNS请求封装在标准的HTTPS流量中，使DNS查询看起来与普通web流量无异。
- DNS over TLS(DoT)
DoT通过专用的TLS连接来加密DNS查询和响应。它使用专用的端口(853)。该端口是用于DNS over TLS(DoT)的默认端口。采用TCP协议。

## 3. IP协议
IP(Internet Protocol)是互联网协议套件的核心协议，位于网络层。主要负责将数据分为数据包(也称IP数据报)通过网络传输到目标地址。  
IP协议是无连接的，不负责建立连接，也不保证数据的可靠传输。  
IP地址是表示网络中设备的唯一标识符，分为两部分：网络地址和主机地址
- IPv4地址采用32位，通常以点分十进制表示。占用4个字节
- IPv6地址采用128位，使用冒号分隔的十六进制形。占用16个字节	
- 子网是IP网络的一部分，通过子网掩码来划分网络地址和主机地址。

### IP数据报
IP数据报结构：IP数据报分为头部和数据
#### IPv4头
IPv4头：一层32位(4字节),基本的是20字节，最大60字节
```
0		4		8				16				24				32
版本	头长	服务类型		|包裹总长
			重组标识			标志|			段偏移量
	生存时间	|协议代码		|			头校验和
							32位源地址
							32位目的地址
```
- 版本：4
- 头长：一层(32,4字节)为单位, 最小5
- 服务类型：描述数据包的优先级和服务类型
- 包裹总长：整个IP数据长度，包括头部和数据，最大65535字节 2^16-1
- 重组标识：用于唯一标识一个数据报，用于数据报的分片和重组
- 标志：3位：第一位必须为0，第二位DF表示不允许分片，第三位指示是否还有更多分片
- 片偏移：当前分片在原始数据报中的位置
- 生存时间：限制数据包在网络中的寿命，每过一个路由器，TTL减1
- 协议：指示上层使用的协议，如TCP, UDP, ICMP等
- 头校验和：用于验证头部数据的完整性
#### IPv4头
ipv6头：固定40字节
```
0		4		8				16				24				32
版本	|	流量类别	|				流标签
			有效载荷长度		|	下一个头	|		跳数限制
							128位源地址
							128位目的地址
```
- 版本：6
- 流量类别：		描述数据包的优先级和服务质量
- 流标签:			标识和优先处理同一流的包
- 有效载荷长度：	后续扩展头部和数据部分的总长度，不含IPv6基本头部，最大65535字节
- 下一个头部：	紧跟在IPv6头部后的扩展头部类型或上层协议类型
- 跳数限制：		类似TTL
	
- 校验  
	ipv6的头部没有校验位，依赖于更高层的校验机制(TCP,UDP);
- 路由  
路由指IP数据包从源地址到目标地址的路径选择过程。路由器根据IP地址和路由表，决定将数据包转发到哪下一跳
- 分片  
在数据包超过传输路径的最大传输单元(MTU)时，将数据包分割成更小的片段进行传输。
	
## 4. UDP和TCP
### TCP
TCP(Transmission Control Protocol)传输控制协议，位于传输层。是面向连接的、可靠的传输协议。
- 特性
	- 面向连接
	- 可靠传输：数据包丢失或出错，TCP会自动重传
	- 流量控制：TCP使用滑动窗口机制，动态调整发送方发送数据的速率,避免接收方因处理不过来而丢失数据
	- 拥塞控制：TCP检测网络的拥塞状态，动态调整数据发送速率，防止网络过载。
		常见的拥塞控制算法包括慢启动、拥塞避免、快速重传、快速恢复
#### 三次握手
三次握手的目的是在客户端和服务端建立双向连接，确认彼此的发送和接收能力。(SYN: Synchronize)
1. 第一次握手(SYN)：客户端->服务端  
	发送SYN包，序列号初始化 seq=x， 进入SYN_SEND状态
2. 第二次握手(SYN—ACK):服务器->客户端。(ACK: Acknowledgment)
	- 服务器响应SYN-ACK包
	- 确认接收到客户端的SYN包，并发送自己的连接请求
	- 确认号:ack=x+1
	- 服务器的序列号初始化 seq=y
	- 服务端进入SYN_RECV状态
3. 第三次握手(ACK)：客户端->服务器
	- 客户端接受到服务端的ACK, SYN报文。
	- 客户端发送ACK包确认服务端的SYN报文，ack=y+1
	- 客户端确认接收到服务器的SYN-ACK包，连接建立完成
	- 发送ACK确认收到连接, Ack=y+1, 序列号更新为x+1
- 客户端和服务器端进入ESTABLISHED状态，完成TCP三次握手

- 为什么需要第三次握手？
	- 确认服务端的SYN报文已被客户端接收
	- 如果客户端没有发送第三次握手的确认，服务器会重发第二次握手报文，客户端也会重发第三次握手报文，直到超时。
	- TCP 是全双工通信，连接是双向的，双方都需要确认对方收到了自己的初始序列号，才能开始可靠的数据传输。	
		
#### 四次挥手
四次挥手用于安全地终止一个TCP连接，确保双方都完成了数据传输,并释放资源
1. 主动关闭方发送FIN seq=u
2. 被动关闭方发送ACK Ack=u+1
3. 被动关闭方发送FIN seq=v
4. 主动关闭方发送ACK，并进入TIME_WAIT状态等待 2 MSL(Maximum Segment Lifetime)时间
	作用是：确保被动关闭方收到ACK(如果最后的ACK丢失，被动关闭方会重发FIN报文), 确保所有旧的重复报文段在网络中消失，避免干扰新的连接
> MSL 表示 一个 TCP 报文段在网络中存在的最长时间, 即报文段从发送到被丢弃或失效所经历的最大时间, 典型值是120秒。
> 第一个MSL确保所有旧报文段消失，第二个MSL保证重传的FIN报文段能被接收并得到ACK。

#### TCP头部格式
```
	0		4		8				16				24				32
			16位源端口				|			16位目标端口
								序列号
								确认号
	首部长度|保留6位|	控制位		| 				窗口大小
				校验和				|				紧急指针
```
- 序列号：在建立连接时由计算机生成的随机数作为初始值，通过SYN包传给接收端主机。每发送一次就累加该大小。用来解决网络包乱序问题
- 确认应答号：指下一次期望收到的数据的序列号。用来解决丢包问题。
- 首部长度：	以32位(4字节)为单位，最小值为5。
- 窗口大小：	用于流量控制，表示接收方当前可接收的字节数
- 校验和： 	用于错误检测，包括TCP头部和数据部分
- 紧急指针：	指出紧急数据的结束位置

#### TCP怎么保障可靠传输：
1. 三次握手和四次挥手
2. 序列号和确认号
3. 确认应答：累计确认机制：一个ACK确认的信息包括之前所有的数据包
4. 超时重传
5. 滑动窗口机制
6. 数据校验

#### TCP判断丢包的方式：
1. 超时重传  
为每个连接维护一个重传定时器。发送数据后，如果在定时器超时之前没有收到对应的确认应答（ACK），TCP会认为该数据包可能丢失，触发重传。超时时间动态计算，基于往返时间（RTT）的估计，称为RTO
2. 快速重传  
TCP接收端收到乱序数据包时，会重复发送最后一个正确接收的数据包的ACK，称为重复ACK（Duplicate ACK）。
发送端连续收到3个或更多相同的重复ACK时，认为后续数据包可能丢失，立即重传该丢失的数据包，而不必等待超时

#### 拆包和粘包
通常发生在基于流式协议的传输中，比如TCP。
- 流式协议：不会为传输的数据包添加边界信息，把数据看作一个连续的字节流而不关心传输的数据是什么
- 数据传输中可能会被分为多个小段传输，或多个小段数据被合并为大段发送。

- **拆包**当数据被拆分为多个小的包发送时，接收方不知道数据的拆分方式(即每个拆包的边界)
- **粘包**多个小数据包被合并为一个大数据包，接收方不知道哪些数据包属于同一条消息(不知道如何分离)。
UDP采用的就是基于数据包的协议，每个数据包有明确边界。
流式协议不关心应用层发送的数据是否分包
##### 拆包和粘包问题解决：
1. 自定义协议：在每个消息添加固定长度的头部，来表示消息的长度或其他标识。
2. 分包标识符：在数据包末尾或开头加上特殊分隔符
3. 固定长度包：但可能会浪费带宽。

#### 超时时间(Retransmission Timeout, RTO)
1. 定义
往返时间(Round-Trip Time, RTT)是指发送方发送一个数据段后，接收到对方确认应答(ACK)的时间间隔。  
- 样本RTT：每当发送一个数据段，发送方开始一个定时器，当收到ACK时,停止定时器，计算出一个样本RTT
- 平滑RTT(Estimated RTT)：使用加权移动平均值来平滑样本RTT，减少短期波动影响
```
	Estimated RTT = (1-alpha)* Estimated RTT + alpha * Sample RTT
```
	alpha常取0.125
-RTT偏差(Dev RTT):用来反映RTT的变化程度
```
Dev RTT = (1- beta)* Dev RTT + beta * |Sample RTT - Estimated RTT|
```

2. RTO计算
```
RTO = Estimated RTT + max(G, K * Dev RTT)
```
- G: 系统时钟的粒度，通常一个小值如1毫秒，防止RTO过低
- K: 一个常数，通常取4，用于放大RTT的偏差，使得RTO在网络波动时依然有效

3. RTO的调整和限制
为避免RTO过小导致频繁重传，或过高导致恢复时间过长，TCP通常设定RTO的下限和上限
- 最小RTO	约为200毫秒
- 最大RTO	根据具体实现，限制在几十秒内  
当发生重传超时(RTO结束前未收到ACK)，TCP会将RTO进行指数级扩展(通常倍增)，以应对可能的网络拥塞，如
```
RTO_new = RTO_current * 2
```

### UDP
UDP(User Datagram Protocol)用户数据报协议，位于传输层，无连接、不可靠。目标是提供快速、低延迟的数据传输
- 特性：
	- 无连接：数据传输前不需要建立连接，发送方可随时发送数包
	- 不可靠传输：不保证数据包的顺序和完整性，也不提供重传机制
	- 低开销
#### UDP头部格式
```
	0		4		8				16				24				32
			16位源端口				|			16位目标端口
			包长度					|				校验和
	包长度包含UDP头部和数据
```
 
## 5. 流量控制
流量控制主要目的是防止发送方发送数据过快，导致接收方因处理能力有限而来不及接收，导致数据丢失或缓冲区溢出的情况。
	
### 滑动窗口机制
滑动窗口是实现流量控制的核心机制。它允许发送方在等待接收方确认的同时，连续发送多个数据包，而无需一一等待确认。

窗口是操作系统开辟的一个缓存空间，发送方主机在等到确认应答返回之前，必须在缓冲区保留已发送的数据。  
如果按期收到确认应答，此时数据可以从缓存区清除。
	
### TCP字段中的Window(窗口大小)
用于接收端告诉发送端自己还有多少缓冲区可以接收数据。发送端根据这个接收端的处理能力来发送数据。
所以窗口大小是由接收方的窗口大小来决定。
		
- 累计确认  
一种应答机制，接收方通过发送一个确认号(ACK)来告知发送方，所有序号小于该确认号的数据包都已成功接收
		
## 6. 拥塞控制
拥塞控制旨在防止因网络中数据流量过大而导致网络拥堵，从而引发数据包丢失、延迟增加等问题。  
拥塞控制主要通过以下步骤实现：
1. 拥塞检测：		通过检测网络表现，如丢包率、往返时间等，判断网络是否处于拥塞状态
2. 调整发送速率：	基于检测结果，动态调整发送方的发送速率
3. 恢复和发送		网络状况改善后适当增加发送速率

### 拥塞控制算法
主要拥塞控制算法有：慢启动、拥塞避免、快速重传与快速恢复、拥塞窗口与慢启动阈值
- 慢启动：
	- 初始化拥塞窗口(cwnd)为一个较小的值 (Congestion window, cwnd)
	- 每收到一个确认应答ACK，cwnd增加一个MSS(maximum segment size)最大报文段长度
	- 直到遇到拥塞信号(如丢包)或cwnd达到慢启动阈值ssthresh(slow start threshold)，进入下一阶段

- 拥塞避免：
	- 在接近网络容量时，逐步增加发送速率，避免过快导致拥塞
	- 机制： 拥塞窗口cwnd增长从指数增长改为线性增长(每一个RTT增加一个MSS)。(Round-Trip Time, 往返时延)

- 快速重传与快速恢复：
	- 快速重传：
		- 当发送方连续收到三个相同的ACK号(代表什么呢？这个ACK代表的包接收方一直没收到),表明某个数据包可能丢失
		- 立即重传该丢失的数据包，而不是等待重传定时器超时
	- 快速恢复：
		- 在快速重传后，将慢启动阈值设置为cwnd的一半
		- 将拥塞窗口设置为慢启动阈值加上三个MSS
		- 每收到一个冗余ACK，cwnd增加一个MSS
		- 一旦收到新的ACK，进入拥塞避免
		
AIMD算法：TCP拥塞控制的核心思想可以被归纳为AIMD
- 加性增加：在拥塞避免阶段，cwnd线性增加
- 乘性减小：在发生拥塞时，cwnd乘以一个因子，大幅减小发送速率。

## 8. 网络劫持
网络劫持是一种网络攻击手段，攻击者通过各种技术拦截、篡改或重定向用户的网络流量，以达到窃取信息、实施欺诈或控制用户设备的目的。
1. DNS劫持
通过篡改DNS解析过程，将用户请求的域名指向恶意服务器
常见方式：  
- 本地DNS被修改：	黑客或恶意软件，改变用户设备的DNS服务器设置
- ISP级DNS劫持：	互联网服务提供商(ISP)拦截和修改DNS请求
		
2. 会话劫持
窃取用户和服务器之间的会话凭证(如Cookies、令牌)  
常见方式：  
- 窃取Cookies：通过XSS(跨站脚本攻击)或网络嗅探获取用户会话Cookies
- 中间人攻击：在用户和服务器之间插入攻击者，实时窃取和篡改通信内容
3. HTTP劫持
利用未加密的HTTP连接，攻击者拦截和篡改用户和服务器之间的通信内容  
常见方式：
- 中间人攻击
- 恶意代理服务器
4. 路由器或网络设备劫持
通过攻击网络路由器或其他网络设备，控制和篡改这些设备的网络流量
常见方式：
- 路由器固件漏洞：利用路由器固件中的安全漏洞获取管理员权限
- 默认密码攻击：	使用未经更改的默认登录凭证访问路由器管理页面
5. 浏览器劫持
修改用户的浏览器设置，如主页、默认搜索引擎等，以引导用户访问恶意网站或展示广告
常见方式：
- 恶意扩展或插件：用户安装包含恶意代码的浏览器扩展
- 恶意软件感染：	通过下载和安装带有劫持功能的恶意软件改变浏览器设置
6. BGP劫持
通过操纵BGP(边缘网络协议)路由信息，将互联网上流量错误引导到攻击者控制的服务器或网络
常见方式：
- 恶意劫持：有意篡改BDP路由表
7. HTTPS劫持
尝试在HTTPS连接中插入恶意证书或利用漏洞，绕过加密保护，窃取或篡改加密通信信息
常见方式：
- 伪造SSL证书：	利用不受信任的证书颁发机构(CA)签发的恶意证书
- 协议降级攻击：	降级HTTPS连接为HTTP,或使用弱加密协议
8. WiFi钓鱼攻击
设置恶意的Wi-Fi热点，诱导用户连接，以拦截和监控其网络流量
8. ARP欺骗
通过发送伪造的ARP消息，欺骗局域网内设备，将攻击者MAC地址与合法IP地址关联
	
				
1. 从输入URL到页面展示发生了什么？
	1. 浏览器收到用户请求，检查浏览器缓存中是否有资源，没有进入下一步
	2. DNS解析获取请求域名的IP地址。如果是HTTPS，还需要建立TLS连接。
		DNS解析按照本地浏览器缓存->本地Host文件->路由器缓存->HOST服务器->根DNS服务器顺序查找域名对应IP
	3. 浏览器与服务器IP建立TCP连接。
		建立连接后，浏览器构建请求行、请求头等信息，并把和域名相关的Cookie等附加到请求头上，向服务器请求信息
	4. 服务器接到响应请求，根据请求生成响应数据。
	5. 浏览器解析响应头。
		若响应头状态码为301、302,重定向到新地址。
		若是字节流类型，将请求交给下载管理器
		若是HTML类型，进入下一步渲染
	6. 浏览器解析HTML文件，创建DOM，解析CSS, 将DOM和CSS合并，构建渲染树
	
3. 四次挥手的过程
	1. 客户端发送一个FIN报文， 报文中会指定一个序列号seq=x。 客户端进入FIN-WAIT-1状态
	2. 服务端收到FIN报文后，回复ACK报文给客户端， ACK: seq=x+1。服务端进入CLOSE_WAIT状态
			客户端进入FIN-WAIT-2状态
	3. 服务端也要断开连接时，发送FIN报文给客户端, 指定序列号seq=y+1。服务端进入LAST-ACK状态
	3. 客户端收到FIN报文，发出ACK报文 seq=y+2。客户端进入TIME-WAIT状态。
		服务端在收到客户端ACK报文后进入CLOSE状态。
		客户端进入TIME_WAIT状态等待	2MSL时间
		
	TCP是全双工通信，双向传输数据。两次握手可以释放一端到另一端的TCP连接
	
4. TCP与UDP
	TCP：传输控制协议，面向连接，可靠，基于字节流
	UDP：用户数据报协议，无连接，不可靠，基于数据报， 传输速度快，所需资源少
	
	TCP在传输数据前有三次握手，传递时有确认、窗口、重传、拥塞控制
	UDP数据传递不需要给出确认，不保证数据不丢失及到达顺序
	TCP只支持点对点通信，UDP支持多播、广播
	
	TCP用于要求通信数据可靠场景(网页、文件传输、登录、数据库)
	UDP要求通信高速(直播、实时游戏)
	
## WebSocket
WebSocket是一种网络通信协议，设计用于在单个TCP连接上进行全双工(双向)通信。简单来说：
- WebSocket允许客户端和服务器之间建立一个持久的连接
- 连接建立后，双方可以随时发送消息，不必为每次通信都重新建立连接
- 适合需要实时双向数据交换的应用，如聊天、游戏、金融行业推送等

### 工作原理
1. 建立连接(握手阶段)
客户端发起HTTP请求，请求头包含特殊字段，表示想升级协议到WebSocket:
```
GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==
Sec-WebSocket-Version: 13
```
服务器响应并同意升级协议
```
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=
```

2. 数据传输阶段
- 连接建立后，客户端和服务器可以随时互相发送消息。
- 数据以"帧(frame)"的形式发送，支持文本和二进制数据。
- 连接保持打开状态，直到一方主动关闭。

3. 关闭连接
- 任何一方都可以发送关闭帧，关闭连接。
- 连接关闭后，双方释放资源。

- WebSocket默认端口和HTTP(80)或HTTPS(443)一致。



