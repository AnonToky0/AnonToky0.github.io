---
title: "硬件结构"
date: 2025-09-01 21:00:00 +0800
categories: [操作系统]
tags: [操作系统, CPU]
---

## 冯诺依曼模型
遵循图灵机设计，定义计算机基本结构为五个部分：运算器、控制器、存储器、输入设备、输出设备。这五个部分也称为**冯诺依曼模型**。

## 内存
计算机存储数据的基本单位是字节(byte)，1字节等于8位。每一个字节都对应一个内存地址。

## 中央处理器(CPU)
32位和64位的主要区别在于一次能计算多少字节数据：
- 32位CPU一次可以计算4个字节
- 64位CPU一次可以计算8个字节

- **位宽**：这里说的32位和64位，代表CPU一次可以计算的数据量。

CPU内部含有其他组件，比如**寄存器**， **控制单元**，**逻辑运算单元**。控制单元负责控制CPU工作，逻辑运算单元负责计算。
寄存器主要用于存储计算时的数据。

### 指令长度
32位CPU的指令长度固定为4个字节。
64位CPU的指令长度依据架构不同：

| 架构类型        | 指令长度特点                          | 程序计数器自增规则                   |
|-----------------|-------------------------------------|------------------------------------|
| 固定长度指令集（如MIPS、ARM 64位模式） | 通常固定为4字节（32位）或8字节（64位） | PC自增固定字节数，比如4或8字节       |
| 变长指令集（如x86-64） | 指令长度可变，从1字节到15字节不等           | PC根据当前指令实际长度自增，长度不固定 |

### 寄存器(Register)
寄存器(Register)是计算机中央处理器(CPU)内部的一种高速存储单元，用于临时存放指令、数据和地址。寄存器是CPU中访问速度最快的存储器，直接参与指令执行和数据处理。

#### 寄存器的作用
- 存储操作数和中间结果：CPU执行指令时，运算的操作数和结果通常存放在寄存器中，避免频繁访问较慢的主存。
- 存储指令地址：程序计数器（PC）寄存器保存下一条将要执行的指令地址。
- 控制程序执行流程：通过状态寄存器（标志寄存器）保存运算结果的状态（如零标志、进位标志等），影响程序分支。
- 支持上下文切换：操作系统切换进程时，会保存和恢复寄存器状态，保证进程执行的连续性。

#### 寄存器种类
- 通用寄存器： 用来存放数据和地址，供算术逻辑运算使用
- 程序计数器(PC)：保存下一条要执行指令的地址
- 指令寄存器(IR)：存放当前正在执行的指令。
- 堆栈指针(SP)： 指向当前堆栈顶的位置，支持函数调用和返回
- 基址寄存器(BP)：用于访问函数的参数和局部变量
- 状态寄存器(标志寄存器): 存放算术运算结果的状态标志，如零标志、进位标志等
- 索引寄存器： 用于数组和字符串操作，支持地址偏移

### 总线
总线用于CPU和内存及其他设备之间的通信，可分为3种：
- 地址总线: 用于指定CPU将要操作的内存地址
- 数据总线：用于读写内存的数据
- 控制总线：用于发送和接收信号，比如中断、设备复位

当CPU读写内存数据时，先通过地址总线指定内存的地址，然后通过控制总线控制是读或写命令，最后通过数据总线来传输数据。

### 线路位宽与CPU位宽
- **线路位宽**是指计算机系统中数据总线、地址总线或控制总线的宽度，即总线上一次能传输的数据位数。
- **CPU位宽**指CPU一次能够处理的数据的位数

CPU 操作 4G大的内存，一次能访问到所有内存地址，需要 32 (2^32)条地址总线。

64位x86-64架构 CPU位宽 64位，数据总线宽度 64位，地址总线宽度 48位，最大寻址空间 256TB。

## 程序执行的基本过程
1. CPU读取**程序计数器**的值，CPU的控制单元操作地址总线指定需要访问的内存地址，接着通知内存设备准备数据，数据准备好后通过数据总线将指令数据传给CPU，CPU收到内存传来的数据后，将这个指令数据存入到指令寄存器
2. 程序计数器的值自增，指向下一条指令。自增大小由CPU位宽决定，32位的CPU指令长度是4字节，由于一条地址占用1个字节，所以程序计数器值自增4。
3. CPU分析指令寄存器中的指令，确定指令的类型和参数。如果是计算类型的指令，把指令交给逻辑运算单元运算；如果是存储类型的指令，交由控制单元执行。

## a = 1 + 2 执行过程
编译阶段，编译器分析代码发现 1 和 2是数据，这两个数是立即数(immediate values)，通常不会单独存放在数据段，而是直接作为指令的一部分编码在机器指令里。而对于变量，会在**编译**阶段放在数据段或只读数据段。

编译器将`a = 1 + 2`翻译成指令，存放在代码段(文本段)，指令举例(X86架构)：

``` 
mov eax, 1    ; 将立即数1加载到寄存器eax
add eax, 2    ; 将立即数2加到eax中，eax = 3
mov [a], eax  ; 将eax的值存储到变量a对应的内存地址
```

### CPU 执行指令步骤
1. 指令取址
- CPU从程序计数器(PC)指向的内存地址读取当前指令的机器码
- 机器码被送入指令寄存器(IR)
2. 指令译码
- CPU的控制单元解析指令，确定操作类型和操作数
- 例如，`mov eax, 1` 指令被译码为“将立即数1加载到eax寄存器”。
3. 操作数取数（Operand Fetch）
- 对于立即数 1 和 2，它们直接编码在指令中，无需访问内存。
- 对于存储变量 a 的内存地址，CPU根据符号表和编译时生成的地址信息，计算出变量 a 的内存地址。
4. 执行
- mov eax, 1：CPU将立即数 1 写入寄存器 eax。
- add eax, 2：CPU将立即数 2 加到 eax 中，eax 现在存储值 3。
- mov [a], eax：CPU将 eax 中的值写入内存地址 a。
5. 写回
- 变量 a 的内存位置被更新，值变为 3。

## 指令
每条指令有对应的机器码，CPU通过解析机器码来获取指令的内容。
不同CPU有不同指令集。

### MIPS指令集
MIPS的指令是一个固定32位的整数。
MIPS指令主要分为三种格式，首6位固定为操作码(opcode)。

| 格式   | 结构                          | 用途                   |
|--------|-------------------------------|------------------------|
| R型    | opcode(6) rs(5) rt(5) rd(5) shamt(5) funct(6) | 寄存器类型指令（算术逻辑运算） |
| I型    | opcode(6) rs(5) rt(5) immediate(16)           | 立即数运算、加载/存储、分支  |
| J型    | opcode(6) address(26)                          | 跳转指令                 |

#### 主要类型
1. 算术逻辑指令（R型）
2. 立即数和加载/存储指令（I型）
3. 跳转指令（J型）

### 4级流水线
将指令执行过程拆分成多个阶段，使多条指令能够并行执行不同阶段的技术。这样可以提高CPU的指令吞吐率。

通常4级流水线包括以下阶段：

| 阶段名称         | 主要功能                             |
|------------------|------------------------------------|
| 1. 取指（IF）    | 从内存中取出下一条指令             |
| 2. 译码/寄存器读（ID） | 解析指令，读取寄存器操作数           |
| 3. 执行/地址计算（EX） | ALU执行算术逻辑运算或计算内存地址   |
| 4. 访存/写回（MEM/WB） | 访问数据内存（load/store）和写回寄存器 |

1. 取指（IF，Instruction Fetch）
CPU根据程序计数器PC，从指令存储器（通常是代码段或指令缓存）读取当前指令。

2. 译码/寄存器读（ID，Instruction Decode / Register Read）
- 解析指令的操作码，确定指令类型。
- 读取指令中指定的寄存器操作数（如rs, rt寄存器）。
- 生成控制信号，准备执行阶段。
- 可能计算分支目标地址。

3. 执行/地址计算（EX，Execution / Address Calculation）
- 算术逻辑单元(ALU, Arithmetic Logic Unit)执行算术或逻辑运算。
- 对于加载/存储指令，计算目标内存地址。
- 对于分支指令，判断条件是否成立。

4. 访存/写回（MEM/WB，Memory Access / Write Back）
- 对于load/store指令，访问数据内存。
- 将ALU或内存读取结果写回寄存器堆。
- 指令执行完成。

4个阶段称为 **指令周期**(Instrution Cycle)，CPU的工作就是一个周期接着一个周期。

### 指令的类型

| 指令类型         | 功能描述                                    | 例子（MIPS指令）          |
|------------------|---------------------------------------------|---------------------------|
| 1. 算术逻辑指令（Arithmetic/Logic） | 执行算术或逻辑运算                         | `add`, `sub`, `and`, `or` |
| 2. 数据传输指令（Data Transfer）  | 在寄存器和内存之间传送数据                   | `lw`（load word）, `sw`（store word） |
| 3. 控制转移指令（Control Transfer） | 改变程序执行流程（跳转、分支）               | `j`(jump), `beq`（branch if equal） |
| 4. 访存指令（Memory Access）       | 访问内存数据，通常是load/store指令           | `lw`, `sw`（与数据传输重叠）|
| 5. 特权指令（System/Privileged）   | 用于操作系统管理，如中断、切换模式等           | `syscall`, `eret`          |

### 指令的执行速度
- **时钟周期**
是CPU内部时钟信号的一个完整周期，是CPU执行操作的基本时间单位。
CPU主频，指的就是每秒钟多少个时钟周期。

想让程序跑的更快，可以优化：  
1. 指令数： 靠编译器优化
2. 每条指令的平均时钟周期数 CPI (Cycles Per Instruction)
通过流水线，让一条指令需要的CPU时钟周期数尽可能的少
3. 时钟周期时间：取决于计算机硬件。

> 软件的32位和64位，指的是？ 指指令的位宽